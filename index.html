<html>
<head></head>
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
<body>
    <form id="startform">
      <input  id="User ID" name="id" type="text" value="" placeholder="User ID" required="true" />
      <input type="hidden" id="latitude" name="x" value="" />
      <input type="hidden" id="longitude" name="y" value="" />
      <input type="submit" value="Start" />
    </form>

    <div id="map" style='width:500px; height:500px; display:none'></div>
    <div id="display" style="height:600px;width:1200px;overflow:auto;background-color:yellowgreen;color:white;scrollbar-base-color:gold;font-family:sans-serif;padding:10px;">
    </div>
    <input type="text" id="chater" name="chater" style="height:40px;width:1220px">
    <input type="button" value="Submit" name="Submit" style="height:40px;width:40px" onclick="chatbox()">
    <script>
      function chatbox(){
          var user_id = document.getElementById("User ID");
          var chater = document.getElementById("chater");
          var display = document.getElementById("display");

          postmessage(user_id, chater);
          display.innerHTML = display.innerHTML + "<br>" + user_id.value + " ==>   " + chater.value;
          chater.value=""
      }
      function postmessage(user_id, chater){
          var form_post = document.createElement("form_post");
          form_post.setAttribute("method", "post");
          form_post.setAttribute("action", "http://10.100.101.74:4567/users");
          var hiddenField = document.createElement("input");
          hiddenField.setAttribute("type", "hidden");
          hiddenField.setAttribute("name", key);
          hiddenField.setAttribute("value", params[key]);
          document.body.appendChild(form_post);
          form_post.submit;
      }
      function getmessage(){

      }
    </script>
</body>
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script>
  var users=[], maphidden = true, markers = [];
    function getLocation() {

         var options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
         };

        function success(pos) {
           successFunction(pos);
        };

        function error(err) {
            console.warn('ERROR(' + err.code + '): ' + err.message);
        };

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error,options);
        } else { 
            //x.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function successFunction(position) {
       var lat = position.coords.latitude;
       var longi = position.coords.longitude;

        $('#latitude').val(lat);
        $('#longitude').val(longi);
    }
    function postdata(){
      $.post('/autoupdate', $('#startform').serialize(), function(data, status){
        $("#startform").hide();
        getUsers();
      });
    }

    function getUsers() {
      $.get('/users', function(data){
        window.users = data;
        showMap();
      });
    }

    
    $("#startform").submit(function(e){
      e.preventDefault();
      postdata();
      setInterval(function() {
        getLocation();
        postdata();  
      }, 1000);
      return false;
    });
    

      function showMap() {
        if (maphidden) {
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 4,
            center: {lat: parseFloat(users[0].x), lng: parseFloat(users[0].y)}
          });  
          $("#map").show();
          maphidden = false;
        }
        for(marker in markers) {
          marker.map = null;
        }
        markers = [];

        for(i in users) {
          user = users[i];
          var marker = new google.maps.Marker({
          position: {lat: parseFloat(user.x), lng:parseFloat(user.y)},
          map: map,
          title: "user" + user.id,
          label: user.id
        });  
          markers.push(marker);
        }
        
      }
    </script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRRckyNOASemizowtX7hqkerHJSt2yhcc">
    </script>
</html>
